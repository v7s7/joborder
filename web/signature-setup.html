<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signature Setup - Job Order Management</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .setup-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-6);
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1e293b 50%, var(--primary-700) 100%);
        }

        .setup-card {
            width: 100%;
            max-width: 540px;
            background: var(--bg-card);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-2xl);
            overflow: hidden;
        }

        .setup-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: var(--space-8);
            text-align: center;
            color: white;
        }

        .setup-header-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto var(--space-4);
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-2xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .setup-header-title {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            margin-bottom: var(--space-2);
        }

        .setup-header-subtitle {
            font-size: var(--font-size-sm);
            opacity: 0.9;
        }

        .setup-body {
            padding: var(--space-8);
        }

        .method-tabs {
            display: flex;
            margin-bottom: var(--space-6);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            padding: 4px;
        }

        .method-tab {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--text-secondary);
            background: none;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .method-tab.active {
            background: var(--bg-card);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .method-tab:hover:not(.active) {
            color: var(--text-primary);
        }

        .method-panel {
            display: none;
        }

        .method-panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .canvas-wrapper {
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: white;
        }

        #signatureCanvas {
            width: 100%;
            height: 200px;
            display: block;
            cursor: crosshair;
            touch-action: none;
        }

        .preview-section {
            margin-top: var(--space-6);
            padding: var(--space-5);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            text-align: center;
        }

        .preview-label {
            font-size: var(--font-size-xs);
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: var(--space-3);
            font-weight: 600;
        }

        .preview-image {
            max-height: 100px;
            max-width: 100%;
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: var(--space-3);
        }

        .error-container {
            text-align: center;
            padding: var(--space-8);
        }

        .error-icon {
            font-size: 64px;
            margin-bottom: var(--space-4);
            opacity: 0.5;
        }

        .success-container {
            text-align: center;
            padding: var(--space-8);
        }

        .success-icon {
            font-size: 80px;
            margin-bottom: var(--space-4);
        }

        .loading-container {
            text-align: center;
            padding: var(--space-12);
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="setup-card">
            <!-- Loading State -->
            <div id="loadingState">
                <div class="loading-container">
                    <div class="spinner" style="margin: 0 auto var(--space-4);"></div>
                    <p class="text-secondary">Validating your invitation...</p>
                </div>
            </div>

            <!-- Error State -->
            <div id="errorState" style="display: none;">
                <div class="error-container">
                    <div class="error-icon">&#10060;</div>
                    <h2 class="font-semibold mb-2">Invalid or Expired Link</h2>
                    <p class="text-secondary mb-6" id="errorMessage">This signature setup link is no longer valid.</p>
                    <a href="/" class="btn btn-primary">Go to Home</a>
                </div>
            </div>

            <!-- Success State -->
            <div id="successState" style="display: none;">
                <div class="success-container">
                    <div class="success-icon">&#9989;</div>
                    <h2 class="font-semibold mb-2">Signature Submitted!</h2>
                    <p class="text-secondary mb-6" id="successMessage">Your signature has been saved and is pending approval.</p>
                    <a href="/" class="btn btn-primary">Go to Home</a>
                </div>
            </div>

            <!-- Setup Form -->
            <div id="setupForm" style="display: none;">
                <div class="setup-header">
                    <div class="setup-header-icon">&#9999;</div>
                    <h1 class="setup-header-title">Digital Signature Setup</h1>
                    <p class="setup-header-subtitle">Hello, <span id="userName">User</span>!</p>
                </div>

                <div class="setup-body">
                    <div class="alert alert-info mb-6">
                        <div class="alert-content">
                            <div class="alert-message">Upload a PNG image of your signature or draw it below.</div>
                        </div>
                    </div>

                    <!-- Method Tabs -->
                    <div class="method-tabs">
                        <button class="method-tab active" data-method="upload">
                            &#128230; Upload Image
                        </button>
                        <button class="method-tab" data-method="draw">
                            &#9998; Draw Signature
                        </button>
                    </div>

                    <!-- Upload Panel -->
                    <div class="method-panel active" id="panel-upload">
                        <div class="upload-zone" id="uploadZone">
                            <div class="upload-zone-icon">&#128230;</div>
                            <div class="upload-zone-text">
                                <strong>Click to upload</strong> or drag and drop<br>
                                <span class="text-sm text-muted">PNG only, max 2MB</span>
                            </div>
                            <input type="file" id="fileInput" accept=".png,image/png" style="display: none;">
                        </div>

                        <div class="preview-section" id="uploadPreview" style="display: none;">
                            <div class="preview-label">Preview</div>
                            <img id="uploadPreviewImg" class="preview-image" alt="Signature Preview">
                            <button type="button" class="btn btn-ghost btn-sm mt-4" onclick="clearUpload()">
                                Remove
                            </button>
                        </div>
                    </div>

                    <!-- Draw Panel -->
                    <div class="method-panel" id="panel-draw">
                        <div class="canvas-wrapper">
                            <canvas id="signatureCanvas"></canvas>
                        </div>
                        <div class="flex gap-4 mt-4">
                            <button type="button" class="btn btn-secondary btn-full" onclick="clearCanvas()">
                                &#128260; Clear
                            </button>
                        </div>

                        <div class="preview-section" id="drawPreview" style="display: none;">
                            <div class="preview-label">Preview</div>
                            <img id="drawPreviewImg" class="preview-image" alt="Signature Preview">
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="mt-6">
                        <button type="button" class="btn btn-primary btn-lg btn-full" id="submitBtn" onclick="submitSignature()">
                            &#10004; Submit Signature
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // =============================================================================
        // STATE
        // =============================================================================
        let token = null;
        let userData = null;
        let uploadedFile = null;
        let canvasDrawing = null;
        let currentMethod = 'upload';

        // Canvas variables
        let canvas, ctx;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // =============================================================================
        // INITIALIZATION
        // =============================================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Get token from URL
            const params = new URLSearchParams(window.location.search);
            token = params.get('token');

            if (!token) {
                showError('No invitation token provided.');
                return;
            }

            validateToken();
            initTabs();
            initUpload();
            initCanvas();
        });

        // =============================================================================
        // TOKEN VALIDATION
        // =============================================================================
        async function validateToken() {
            try {
                const res = await fetch(`/api/signature/validate-token?token=${token}`);
                const data = await res.json();

                if (data.valid) {
                    userData = data;
                    document.getElementById('userName').textContent = data.name;
                    showForm();
                } else {
                    showError(data.error || 'Invalid or expired token');
                }
            } catch (err) {
                showError('Failed to validate token. Please try again.');
            }
        }

        function showForm() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('setupForm').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').style.display = 'block';
        }

        function showSuccess(message) {
            document.getElementById('setupForm').style.display = 'none';
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successState').style.display = 'block';
        }

        // =============================================================================
        // TABS
        // =============================================================================
        function initTabs() {
            document.querySelectorAll('.method-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.method-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.method-panel').forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`panel-${tab.dataset.method}`).classList.add('active');
                    currentMethod = tab.dataset.method;
                });
            });
        }

        // =============================================================================
        // FILE UPLOAD
        // =============================================================================
        function initUpload() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            uploadZone.addEventListener('click', () => fileInput.click());

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', () => {
                handleFiles(fileInput.files);
            });
        }

        function handleFiles(files) {
            if (files.length === 0) return;

            const file = files[0];

            // Validate file type
            if (file.type !== 'image/png') {
                showToast('Please upload a PNG file only', 'error');
                return;
            }

            // Validate file size (2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('File size must be under 2MB', 'error');
                return;
            }

            uploadedFile = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('uploadPreviewImg').src = e.target.result;
                document.getElementById('uploadPreview').style.display = 'block';
                document.getElementById('uploadZone').style.display = 'none';
            };
            reader.readAsDataURL(file);

            showToast('File uploaded successfully', 'success');
        }

        function clearUpload() {
            uploadedFile = null;
            document.getElementById('uploadPreview').style.display = 'none';
            document.getElementById('uploadZone').style.display = 'block';
            document.getElementById('fileInput').value = '';
        }

        // =============================================================================
        // CANVAS DRAWING
        // =============================================================================
        function initCanvas() {
            canvas = document.getElementById('signatureCanvas');
            ctx = canvas.getContext('2d');

            // Set canvas size
            function resizeCanvas() {
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * 2;
                canvas.height = 200 * 2;
                ctx.scale(2, 2);
                ctx.strokeStyle = '#1e293b';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
            }

            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = getCoords(e);
        }

        function draw(e) {
            if (!isDrawing) return;

            const [x, y] = getCoords(e);

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();

            [lastX, lastY] = [x, y];
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                updateDrawPreview();
            }
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            startDrawing(mouseEvent);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            draw(mouseEvent);
        }

        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            return [
                (e.clientX - rect.left),
                (e.clientY - rect.top)
            ];
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('drawPreview').style.display = 'none';
            canvasDrawing = null;
        }

        function updateDrawPreview() {
            // Convert white to transparent
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                if (data[i] > 250 && data[i + 1] > 250 && data[i + 2] > 250) {
                    data[i + 3] = 0; // Make white pixels transparent
                }
            }

            // Create temp canvas for preview
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.putImageData(imageData, 0, 0);

            canvasDrawing = tempCanvas.toDataURL('image/png');
            document.getElementById('drawPreviewImg').src = canvasDrawing;
            document.getElementById('drawPreview').style.display = 'block';
        }

        // =============================================================================
        // SUBMIT
        // =============================================================================
        async function submitSignature() {
            const submitBtn = document.getElementById('submitBtn');

            // Validate
            if (currentMethod === 'upload' && !uploadedFile) {
                showToast('Please upload a signature image', 'warning');
                return;
            }

            if (currentMethod === 'draw' && !canvasDrawing) {
                showToast('Please draw your signature', 'warning');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.classList.add('btn-loading');

            try {
                let res;

                if (currentMethod === 'upload') {
                    const formData = new FormData();
                    formData.append('token', token);
                    formData.append('signature', uploadedFile);

                    res = await fetch('/api/signature/setup', {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    res = await fetch('/api/signature/setup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            token,
                            signatureData: canvasDrawing
                        })
                    });
                }

                const data = await res.json();

                if (data.ok) {
                    showSuccess(data.message || 'Signature saved successfully!');
                } else {
                    showToast(data.error || 'Failed to save signature', 'error');
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('btn-loading');
                }
            } catch (err) {
                showToast('Failed to submit signature. Please try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.classList.remove('btn-loading');
            }
        }

        // =============================================================================
        // TOAST
        // =============================================================================
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '&#9989;' : type === 'error' ? '&#10060;' : '&#9888;'}</span>
                <span>${message}</span>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'toastSlideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
