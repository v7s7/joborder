<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Signature Management</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .admin-header h1 {
            margin: 0;
        }

        .admin-nav {
            display: flex;
            gap: 10px;
        }

        .admin-nav a {
            color: var(--primary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .admin-nav a:hover {
            background: #E8F0FE;
        }

        /* Tabs */
        .admin-tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 25px;
        }

        .admin-tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.2s;
            position: relative;
        }

        .admin-tab.active {
            color: var(--primary);
        }

        .admin-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        .admin-tab .badge {
            background: #EA4335;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Search section */
        .search-section {
            margin-bottom: 30px;
        }

        .search-box {
            display: flex;
            gap: 10px;
        }

        .search-box input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        .search-box button {
            padding: 12px 24px;
        }

        /* Results */
        .results-list {
            margin-top: 20px;
        }

        .result-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
        }

        .result-item:hover {
            border-color: var(--primary);
        }

        .result-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .result-info {
            flex: 1;
        }

        .result-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .result-email {
            font-size: 13px;
            color: var(--text-muted);
        }

        .result-status {
            margin-right: 15px;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.approved {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .status-badge.pending {
            background: #FFF3E0;
            color: #E65100;
        }

        .status-badge.none {
            background: #F5F5F5;
            color: #757575;
        }

        /* Pending signatures */
        .signature-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            background: white;
        }

        .signature-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .signature-preview {
            background: #F5F5F5;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
        }

        .signature-preview img {
            max-width: 200px;
            max-height: 80px;
        }

        .signature-actions {
            display: flex;
            gap: 10px;
        }

        .btn-approve {
            background: #0F9D58;
            color: white;
        }

        .btn-approve:hover {
            background: #0B8043;
        }

        .btn-reject {
            background: #EA4335;
            color: white;
        }

        .btn-reject:hover {
            background: #D32F2F;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--text-main);
        }

        /* Alerts */
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #E8F5E9;
            color: #2E7D32;
            display: block;
        }

        .alert.error {
            background: #FFEBEE;
            color: #C62828;
            display: block;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>Signature Management</h1>
            <div class="admin-nav">
                <a href="/">Back to Job Orders</a>
            </div>
        </div>

        <div id="alert" class="alert"></div>

        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="invite">Invite Staff</button>
            <button class="admin-tab" data-tab="pending">
                Pending Approval
                <span class="badge" id="pendingCount" style="display: none;">0</span>
            </button>
            <button class="admin-tab" data-tab="all">All Signatures</button>
        </div>

        <!-- Invite Tab -->
        <div class="tab-panel active" id="panel-invite">
            <div class="card">
                <h2>Search Directory</h2>
                <p style="color: var(--text-muted); margin-bottom: 20px;">
                    Search for staff in Active Directory to invite them to set up their signature.
                </p>

                <div class="search-section">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Search by name or email..." autocomplete="off">
                        <button class="btn-primary" onclick="searchDirectory()">Search</button>
                    </div>
                </div>

                <div class="results-list" id="searchResults"></div>
            </div>
        </div>

        <!-- Pending Tab -->
        <div class="tab-panel" id="panel-pending">
            <div id="pendingList"></div>
        </div>

        <!-- All Signatures Tab -->
        <div class="tab-panel" id="panel-all">
            <div id="allSignatures"></div>
        </div>
    </div>

    <script>
        // Tab functionality
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`panel-${tab.dataset.tab}`).classList.add('active');

                if (tab.dataset.tab === 'pending') loadPending();
                if (tab.dataset.tab === 'all') loadAllSignatures();
            });
        });

        // Search with Enter key
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchDirectory();
        });

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadPendingCount();
        });

        async function checkAuth() {
            try {
                const res = await fetch('/auth/me', { credentials: 'include' });
                if (!res.ok) {
                    window.location.href = '/';
                    return;
                }

                const data = await res.json();
                if (!data.user || !data.user.isAdmin) {
                    alert('Access denied. Admin privileges required.');
                    window.location.href = '/';
                    return;
                }
            } catch (err) {
                window.location.href = '/';
            }
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type}`;
            setTimeout(() => { alert.className = 'alert'; }, 5000);
        }

        async function searchDirectory() {
            const query = document.getElementById('searchInput').value.trim();
            if (query.length < 2) {
                showAlert('Please enter at least 2 characters', 'error');
                return;
            }

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<p style="color: var(--text-muted);">Searching...</p>';

            try {
                const res = await fetch(`/api/admin/search-directory?q=${encodeURIComponent(query)}`, {
                    credentials: 'include'
                });

                if (!res.ok) throw new Error('Search failed');

                const data = await res.json();

                if (data.users.length === 0) {
                    resultsDiv.innerHTML = '<div class="empty-state"><h3>No results found</h3><p>Try a different search term</p></div>';
                    return;
                }

                resultsDiv.innerHTML = data.users.map(user => `
                    <div class="result-item">
                        <div class="result-avatar">${(user.name || 'U').charAt(0).toUpperCase()}</div>
                        <div class="result-info">
                            <div class="result-name">${user.name || user.username}</div>
                            <div class="result-email">${user.email}</div>
                        </div>
                        <div class="result-status">
                            ${user.signatureStatus === 'approved'
                                ? '<span class="status-badge approved">Has Signature</span>'
                                : user.signatureStatus === 'pending'
                                    ? '<span class="status-badge pending">Pending</span>'
                                    : '<span class="status-badge none">No Signature</span>'
                            }
                        </div>
                        ${!user.hasSignature ? `
                            <button class="btn-primary" onclick="inviteUser('${user.email}', '${user.name}', '${user.username}')">
                                Send Invite
                            </button>
                        ` : ''}
                    </div>
                `).join('');

            } catch (err) {
                resultsDiv.innerHTML = '<div class="empty-state error"><h3>Search failed</h3><p>Please try again</p></div>';
            }
        }

        async function inviteUser(email, name, username) {
            try {
                const res = await fetch('/api/admin/invite-signature', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, name, username })
                });

                const data = await res.json();

                if (data.ok) {
                    showAlert(`Invitation sent to ${email}`, 'success');
                    searchDirectory(); // Refresh results
                } else {
                    showAlert(data.error || 'Failed to send invitation', 'error');
                }
            } catch (err) {
                showAlert('Failed to send invitation', 'error');
            }
        }

        async function loadPendingCount() {
            try {
                const res = await fetch('/api/admin/pending-signatures', { credentials: 'include' });
                const data = await res.json();
                const count = data.signatures.length;
                const badge = document.getElementById('pendingCount');
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
            } catch (err) {
                console.error('Failed to load pending count');
            }
        }

        async function loadPending() {
            const listDiv = document.getElementById('pendingList');
            listDiv.innerHTML = '<p style="color: var(--text-muted);">Loading...</p>';

            try {
                const res = await fetch('/api/admin/pending-signatures', { credentials: 'include' });
                const data = await res.json();

                if (data.signatures.length === 0) {
                    listDiv.innerHTML = '<div class="empty-state"><h3>No pending signatures</h3><p>All signatures have been reviewed</p></div>';
                    return;
                }

                listDiv.innerHTML = data.signatures.map(sig => `
                    <div class="signature-card" id="sig-${sig.userId}">
                        <div class="signature-header">
                            <div>
                                <h3 style="margin: 0 0 5px;">${sig.name}</h3>
                                <p style="margin: 0; color: var(--text-muted);">${sig.email}</p>
                            </div>
                            <span class="status-badge pending">Pending</span>
                        </div>
                        <div class="signature-preview">
                            <img src="${sig.signatureUrl}" alt="Signature">
                        </div>
                        <div class="signature-actions">
                            <button class="btn-approve" onclick="approveSignature('${sig.userId}')">Approve</button>
                            <button class="btn-reject" onclick="rejectSignature('${sig.userId}')">Reject</button>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                listDiv.innerHTML = '<div class="empty-state error"><h3>Failed to load</h3></div>';
            }
        }

        async function approveSignature(userId) {
            if (!confirm('Approve this signature?')) return;

            try {
                const res = await fetch(`/api/admin/approve-signature/${userId}`, {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await res.json();

                if (data.ok) {
                    document.getElementById(`sig-${userId}`).remove();
                    showAlert('Signature approved', 'success');
                    loadPendingCount();
                } else {
                    showAlert(data.error || 'Failed to approve', 'error');
                }
            } catch (err) {
                showAlert('Failed to approve signature', 'error');
            }
        }

        async function rejectSignature(userId) {
            if (!confirm('Reject and delete this signature? The staff will need to be invited again.')) return;

            try {
                const res = await fetch(`/api/admin/reject-signature/${userId}`, {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await res.json();

                if (data.ok) {
                    document.getElementById(`sig-${userId}`).remove();
                    showAlert('Signature rejected', 'success');
                    loadPendingCount();
                } else {
                    showAlert(data.error || 'Failed to reject', 'error');
                }
            } catch (err) {
                showAlert('Failed to reject signature', 'error');
            }
        }

        async function loadAllSignatures() {
            const listDiv = document.getElementById('allSignatures');
            listDiv.innerHTML = '<p style="color: var(--text-muted);">Loading...</p>';

            try {
                const res = await fetch('/api/signatures', { credentials: 'include' });
                const data = await res.json();

                if (data.signatures.length === 0) {
                    listDiv.innerHTML = '<div class="empty-state"><h3>No approved signatures</h3><p>Invite staff to set up their signatures</p></div>';
                    return;
                }

                listDiv.innerHTML = data.signatures.map(sig => `
                    <div class="result-item">
                        <div class="result-avatar">${(sig.name || 'U').charAt(0).toUpperCase()}</div>
                        <div class="result-info">
                            <div class="result-name">${sig.name}</div>
                            <div class="result-email">${sig.email}</div>
                        </div>
                        <div class="signature-preview" style="padding: 10px; margin: 0; background: transparent; border: none;">
                            <img src="${sig.signatureUrl}" alt="Signature" style="max-height: 40px;">
                        </div>
                        <span class="status-badge approved">Approved</span>
                    </div>
                `).join('');

            } catch (err) {
                listDiv.innerHTML = '<div class="empty-state error"><h3>Failed to load</h3></div>';
            }
        }
    </script>
</body>
</html>
