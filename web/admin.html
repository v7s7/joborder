<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signature Management - Job Order Management</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/dashboard.html" class="sidebar-logo">
                    <div class="sidebar-logo-icon">JO</div>
                    <div>
                        <div class="sidebar-logo-text">Job Orders</div>
                        <div class="sidebar-logo-subtitle">Management System</div>
                    </div>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main Menu</div>
                    <a href="/dashboard.html" class="nav-item">
                        Dashboard
                    </a>
                    <a href="/" class="nav-item">
                        New Job Order
                    </a>
                    <a href="/reports.html" class="nav-item">
                        Reports
                    </a>
                    <a href="/pending-approvals.html" class="nav-item">
                        Pending Approvals
                        <span class="nav-item-badge" id="approvalsBadge" style="display: none;">0</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Administration</div>
                    <a href="/admin.html" class="nav-item active">
                        Signatures
                        <span class="nav-item-badge" id="pendingBadgeSidebar" style="display: none;">0</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="sidebar-user" id="sidebarUser">
                    <div class="sidebar-user-avatar" id="sidebarAvatar">U</div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name" id="sidebarUserName">User</div>
                        <div class="sidebar-user-role" id="sidebarUserRole">Administrator</div>
                    </div>
                </div>
                <button class="btn btn-ghost btn-full mt-2" id="settingsBtn" style="justify-content: flex-start; gap: 12px;">
                    Settings
                </button>
                <button class="btn btn-ghost btn-full mt-2" id="logoutBtn" style="justify-content: flex-start; gap: 12px;">
                    Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="icon-btn mobile-menu-toggle" id="menuToggle" style="display: none;">Menu</button>
                    <div>
                        <h1 class="page-title">Signature Management</h1>
                        <div class="breadcrumb">
                            <span>Home</span>
                            <span class="breadcrumb-separator">/</span>
                            <span>Administration</span>
                            <span class="breadcrumb-separator">/</span>
                            <span>Signatures</span>
                        </div>
                    </div>
                </div>
                <div class="top-bar-right">
                    <div class="status-indicator ready">
                        <span class="status-dot"></span>
                        <span>Admin Mode</span>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                <!-- Stats Grid -->
                <div class="stats-grid mb-6" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card" style="--stat-color: var(--success);">
                        <div class="stat-card-icon success"></div>
                        <div class="stat-card-content">
                            <div class="stat-card-title">Approved Signatures</div>
                            <div class="stat-card-value" id="statApproved">0</div>
                        </div>
                    </div>
                    <div class="stat-card" style="--stat-color: var(--warning);">
                        <div class="stat-card-icon warning"></div>
                        <div class="stat-card-content">
                            <div class="stat-card-title">Pending Approval</div>
                            <div class="stat-card-value" id="statPending">0</div>
                        </div>
                    </div>
                    <div class="stat-card" style="--stat-color: var(--info);">
                        <div class="stat-card-icon info"></div>
                        <div class="stat-card-content">
                            <div class="stat-card-title">Invitations Sent</div>
                            <div class="stat-card-value" id="statInvitations">0</div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Card -->
                <div class="card">
                    <!-- Tabs -->
                    <div class="tabs" style="padding: 0 24px; margin-bottom: 0; border-bottom: 2px solid var(--border-light);">
                        <button class="tab active" data-tab="invite">
                            Invite Staff
                        </button>
                        <button class="tab" data-tab="pending">
                            Pending Approval
                            <span class="tab-badge" id="pendingBadge" style="display: none;">0</span>
                        </button>
                        <button class="tab" data-tab="all">
                            All Signatures
                        </button>
                    </div>

                    <!-- Tab Panels -->
                    <div class="card-body">
                        <!-- Invite Tab -->
                        <div class="tab-panel active" id="panel-invite">
                            <div class="mb-6">
                                <h3 class="font-semibold mb-2">Search Directory</h3>
                                <p class="text-secondary text-sm">Search for staff members in Active Directory to invite them to set up their digital signature.</p>
                            </div>

                            <div class="search-box mb-6">
                                <input type="text" class="form-input" id="searchInput" placeholder="Search by name or email (min. 2 characters)..." autocomplete="off">
                                <button class="btn btn-primary" onclick="searchDirectory()">
                                    Search
                                </button>
                            </div>

                            <div id="searchResults">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <div class="empty-state-title">Search Directory</div>
                                    <div class="empty-state-description">Enter a name or email address to search for staff members in Active Directory.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Pending Tab -->
                        <div class="tab-panel" id="panel-pending">
                            <div id="pendingList">
                                <div class="empty-state">
                                    <div class="spinner"></div>
                                    <p class="loading-text mt-4">Loading pending signatures...</p>
                                </div>
                            </div>
                        </div>

                        <!-- All Signatures Tab -->
                        <div class="tab-panel" id="panel-all">
                            <div id="allSignatures">
                                <div class="empty-state">
                                    <div class="spinner"></div>
                                    <p class="loading-text mt-4">Loading signatures...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Settings</h3>
                <button class="modal-close" id="closeSettingsModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="settingsForm">
                    <div class="form-group">
                        <label class="form-label">Save Reports To</label>
                        <div class="flex gap-2">
                            <input type="text" class="form-input" id="savePathInput" placeholder="e.g., \\\\server\\share\\Reports or C:\\Reports">
                            <button type="button" class="btn btn-secondary" id="browseSavePathBtn">Browse</button>
                        </div>
                        <input type="file" id="savePathPicker" webkitdirectory directory style="display: none;">
                        <small class="text-secondary" style="display: block; margin-top: 8px;">
                            Enter a network path or local folder where generated reports will be saved.
                            Leave empty to use the default server location.
                        </small>
                    </div>
                    <div class="flex gap-4 mt-4">
                        <button type="button" class="btn btn-secondary btn-full" id="cancelSettingsBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary btn-full">Save Settings</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // =============================================================================
        // STATE
        // =============================================================================
        let currentUser = null;

        // =============================================================================
        // DOM ELEMENTS
        // =============================================================================
        const logoutBtn = document.getElementById('logoutBtn');
        const settingsModal = document.getElementById('settingsModal');
        const settingsForm = document.getElementById('settingsForm');
        const settingsBtn = document.getElementById('settingsBtn');

        // =============================================================================
        // INITIALIZATION
        // =============================================================================
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            initTabs();

            // Event listeners
            logoutBtn.addEventListener('click', handleLogout);
            if (settingsBtn) {
                settingsBtn.addEventListener('click', openSettingsModal);
            }
            const closeSettingsModal = document.getElementById('closeSettingsModal');
            const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');
            if (closeSettingsModal) {
                closeSettingsModal.addEventListener('click', () => settingsModal.classList.remove('active'));
            }
            if (cancelSettingsBtn) {
                cancelSettingsBtn.addEventListener('click', () => settingsModal.classList.remove('active'));
            }
            if (settingsForm) {
                settingsForm.addEventListener('submit', handleSaveSettings);
            }
            setupSavePathPicker();
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchDirectory();
            });
        });

        // =============================================================================
        // TABS
        // =============================================================================
        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`panel-${tab.dataset.tab}`).classList.add('active');

                    if (tab.dataset.tab === 'pending') loadPending();
                    if (tab.dataset.tab === 'all') loadAllSignatures();
                });
            });
        }

        // =============================================================================
        // AUTH
        // =============================================================================
        async function checkAuth() {
            try {
                const res = await fetch('/auth/me', { credentials: 'include' });
                if (!res.ok) {
                    window.location.href = '/';
                    return;
                }

                const data = await res.json();
                if (!data.user || !data.user.isAdmin) {
                    showToast('Access denied. Admin privileges required.', 'error');
                    setTimeout(() => window.location.href = '/', 2000);
                    return;
                }

                currentUser = data.user;
                updateUserUI();
                loadStats();
                loadPendingCount();
            } catch (err) {
                window.location.href = '/';
            }
        }

        async function handleLogout() {
            try {
                await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
            } catch (error) {
                console.error('Logout error:', error);
            }
            window.location.href = '/';
        }

        function updateUserUI() {
            document.getElementById('sidebarAvatar').textContent = (currentUser.name || currentUser.username).charAt(0).toUpperCase();
            document.getElementById('sidebarUserName').textContent = currentUser.name || currentUser.username;
        }

        // =============================================================================
        // USER SETTINGS
        // =============================================================================
        async function openSettingsModal() {
            if (!settingsModal) return;

            try {
                const response = await fetch('/api/user/settings', { credentials: 'include' });
                const data = await response.json();

                if (data.success) {
                    const savePathInput = document.getElementById('savePathInput');
                    if (savePathInput) {
                        savePathInput.value = data.settings.savePath || '';
                    }
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }

            settingsModal.classList.add('active');
        }

        async function handleSaveSettings(e) {
            e.preventDefault();

            const savePathInput = document.getElementById('savePathInput');
            const savePath = savePathInput ? savePathInput.value.trim() : '';

            try {
                const response = await fetch('/api/user/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ savePath })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Settings saved successfully!', 'success');
                    settingsModal.classList.remove('active');
                } else {
                    showToast(data.error || 'Failed to save settings', 'error');
                }
            } catch (error) {
                console.error('Failed to save settings:', error);
                showToast('Failed to save settings', 'error');
            }
        }

        function setupSavePathPicker() {
            const browseBtn = document.getElementById('browseSavePathBtn');
            const savePathInput = document.getElementById('savePathInput');
            const savePathPicker = document.getElementById('savePathPicker');

            if (!browseBtn || !savePathInput) return;

            browseBtn.addEventListener('click', async () => {
                if (window.showDirectoryPicker) {
                    try {
                        const handle = await window.showDirectoryPicker();
                        if (handle?.name) {
                            savePathInput.value = handle.name;
                        }
                        return;
                    } catch (error) {
                        if (error?.name !== 'AbortError') {
                            console.error('Failed to open directory picker:', error);
                        }
                    }
                }

                if (savePathPicker) {
                    savePathPicker.click();
                }
            });

            if (savePathPicker) {
                savePathPicker.addEventListener('change', () => {
                    const file = savePathPicker.files?.[0];
                    if (!file) return;
                    const path = getSelectedDirectoryPath(file);
                    if (path) {
                        savePathInput.value = path;
                    }
                    savePathPicker.value = '';
                });
            }
        }

        function getSelectedDirectoryPath(file) {
            if (!file) {
                return '';
            }
            if (file.path) {
                if (file.webkitRelativePath) {
                    const normalizedPath = file.path.replace(/\\/g, '/');
                    if (normalizedPath.endsWith(file.webkitRelativePath)) {
                        const basePath = normalizedPath.slice(0, -file.webkitRelativePath.length);
                        return basePath.replace(/\/$/, '');
                    }
                }
                const lastSeparator = Math.max(file.path.lastIndexOf('/'), file.path.lastIndexOf('\\'));
                return lastSeparator >= 0 ? file.path.slice(0, lastSeparator) : file.path;
            }
            if (file.webkitRelativePath) {
                const segments = file.webkitRelativePath.split('/');
                return segments.length > 1 ? segments[0] : file.webkitRelativePath;
            }
            return file.name || '';
        }

        // =============================================================================
        // STATS
        // =============================================================================
        async function loadStats() {
            try {
                // Load approved signatures count
                const sigRes = await fetch('/api/signatures', { credentials: 'include' });
                const sigData = await sigRes.json();
                document.getElementById('statApproved').textContent = sigData.signatures?.length || 0;

                // Load pending count
                const pendRes = await fetch('/api/admin/pending-signatures', { credentials: 'include' });
                const pendData = await pendRes.json();
                document.getElementById('statPending').textContent = pendData.signatures?.length || 0;

                // Invitations (estimate based on signatures)
                document.getElementById('statInvitations').textContent = (sigData.signatures?.length || 0) + (pendData.signatures?.length || 0);
            } catch (error) {
                console.error('Failed to load stats');
            }
        }

        async function loadPendingCount() {
            try {
                const res = await fetch('/api/admin/pending-signatures', { credentials: 'include' });
                const data = await res.json();
                const count = data.signatures?.length || 0;

                const badge = document.getElementById('pendingBadge');
                const sidebarBadge = document.getElementById('pendingBadgeSidebar');

                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline';
                    sidebarBadge.textContent = count;
                    sidebarBadge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                    sidebarBadge.style.display = 'none';
                }
            } catch (err) {
                console.error('Failed to load pending count');
            }
        }

        // =============================================================================
        // DIRECTORY SEARCH
        // =============================================================================
        async function searchDirectory() {
            const query = document.getElementById('searchInput').value.trim();
            if (query.length < 2) {
                showToast('Please enter at least 2 characters', 'warning');
                return;
            }

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = `
                <div class="empty-state" style="padding: 40px;">
                    <div class="spinner"></div>
                    <p class="loading-text mt-4">Searching directory...</p>
                </div>
            `;

            try {
                const res = await fetch(`/api/admin/search-directory?q=${encodeURIComponent(query)}`, {
                    credentials: 'include'
                });

                if (!res.ok) throw new Error('Search failed');

                const data = await res.json();

                if (data.users.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <div class="empty-state-title">No Results Found</div>
                            <div class="empty-state-description">No users found matching "${query}". Try a different search term.</div>
                        </div>
                    `;
                    return;
                }

                resultsDiv.innerHTML = data.users.map(user => `
                    <div class="list-item">
                        <div class="list-item-avatar">
                            <div class="avatar">${(user.name || 'U').charAt(0).toUpperCase()}</div>
                        </div>
                        <div class="list-item-content">
                            <div class="list-item-title">${user.name || user.username}</div>
                            <div class="list-item-subtitle">${user.email}</div>
                        </div>
                        <div class="list-item-actions">
                            ${user.signatureStatus === 'approved'
                                ? '<span class="badge badge-success">Has Signature</span>'
                                : user.signatureStatus === 'pending'
                                    ? '<span class="badge badge-warning">Pending</span>'
                                    : `<button class="btn btn-primary btn-sm" onclick="inviteUser('${user.email}', '${user.name}', '${user.username}')">
                                        Send Invite
                                       </button>`
                            }
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                resultsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-title">Search Failed</div>
                        <div class="empty-state-description">Unable to search the directory. Please try again.</div>
                    </div>
                `;
            }
        }

        async function inviteUser(email, name, username) {
            try {
                const res = await fetch('/api/admin/invite-signature', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, name, username })
                });

                const data = await res.json();

                if (data.ok) {
                    showToast(`Invitation sent to ${email}`, 'success');
                    searchDirectory(); // Refresh results
                } else {
                    showToast(data.error || 'Failed to send invitation', 'error');
                }
            } catch (err) {
                showToast('Failed to send invitation', 'error');
            }
        }

        // =============================================================================
        // PENDING SIGNATURES
        // =============================================================================
        async function loadPending() {
            const listDiv = document.getElementById('pendingList');
            listDiv.innerHTML = `
                <div class="empty-state" style="padding: 40px;">
                    <div class="spinner"></div>
                    <p class="loading-text mt-4">Loading pending signatures...</p>
                </div>
            `;

            try {
                const res = await fetch('/api/admin/pending-signatures', { credentials: 'include' });
                const data = await res.json();

                if (data.signatures.length === 0) {
                    listDiv.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <div class="empty-state-title">All Caught Up!</div>
                            <div class="empty-state-description">There are no signatures pending approval.</div>
                        </div>
                    `;
                    return;
                }

                listDiv.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        ${data.signatures.map(sig => `
                            <div class="card" id="sig-${sig.userId}">
                                <div class="card-body">
                                    <div class="flex items-center gap-4 mb-4">
                                        <div class="avatar avatar-lg">${(sig.name || 'U').charAt(0).toUpperCase()}</div>
                                        <div>
                                            <h4 class="font-semibold">${sig.name}</h4>
                                            <p class="text-secondary text-sm">${sig.email}</p>
                                        </div>
                                        <span class="badge badge-warning" style="margin-left: auto;">Pending</span>
                                    </div>
                                    <div class="signature-preview mb-4">
                                        <img src="${sig.signatureUrl}" alt="Signature">
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="btn btn-success btn-full" onclick="approveSignature('${sig.userId}')">
                                            Approve
                                        </button>
                                        <button class="btn btn-danger btn-full" onclick="rejectSignature('${sig.userId}')">
                                            Reject
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

            } catch (err) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-title">Failed to Load</div>
                        <div class="empty-state-description">Unable to load pending signatures.</div>
                    </div>
                `;
            }
        }

        async function approveSignature(userId) {
            if (!confirm('Approve this signature?')) return;

            try {
                const res = await fetch(`/api/admin/approve-signature/${userId}`, {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await res.json();

                if (data.ok) {
                    document.getElementById(`sig-${userId}`).remove();
                    showToast('Signature approved successfully', 'success');
                    loadPendingCount();
                    loadStats();
                } else {
                    showToast(data.error || 'Failed to approve', 'error');
                }
            } catch (err) {
                showToast('Failed to approve signature', 'error');
            }
        }

        async function rejectSignature(userId) {
            if (!confirm('Reject and delete this signature? The staff will need to be invited again.')) return;

            try {
                const res = await fetch(`/api/admin/reject-signature/${userId}`, {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await res.json();

                if (data.ok) {
                    document.getElementById(`sig-${userId}`).remove();
                    showToast('Signature rejected', 'success');
                    loadPendingCount();
                    loadStats();
                } else {
                    showToast(data.error || 'Failed to reject', 'error');
                }
            } catch (err) {
                showToast('Failed to reject signature', 'error');
            }
        }

        // =============================================================================
        // ALL SIGNATURES
        // =============================================================================
        async function loadAllSignatures() {
            const listDiv = document.getElementById('allSignatures');
            listDiv.innerHTML = `
                <div class="empty-state" style="padding: 40px;">
                    <div class="spinner"></div>
                    <p class="loading-text mt-4">Loading signatures...</p>
                </div>
            `;

            try {
                const res = await fetch('/api/signatures', { credentials: 'include' });
                const data = await res.json();

                if (data.signatures.length === 0) {
                    listDiv.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <div class="empty-state-title">No Signatures Yet</div>
                            <div class="empty-state-description">Invite staff members to set up their digital signatures.</div>
                        </div>
                    `;
                    return;
                }

                listDiv.innerHTML = data.signatures.map(sig => `
                    <div class="list-item">
                        <div class="list-item-avatar">
                            <div class="avatar">${(sig.name || 'U').charAt(0).toUpperCase()}</div>
                        </div>
                        <div class="list-item-content">
                            <div class="list-item-title">${sig.name}</div>
                            <div class="list-item-subtitle">${sig.email}</div>
                        </div>
                        <div class="signature-preview" style="padding: 8px; margin: 0; background: transparent; border: none;">
                            <img src="${sig.signatureUrl}" alt="Signature" style="max-height: 40px;">
                        </div>
                        <span class="badge badge-success">Approved</span>
                    </div>
                `).join('');

            } catch (err) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-title">Failed to Load</div>
                        <div class="empty-state-description">Unable to load signatures.</div>
                    </div>
                `;
            }
        }

        // =============================================================================
        // TOAST NOTIFICATIONS
        // =============================================================================
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '' : type === 'error' ? '' : ''}</span>
                <span>${message}</span>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'toastSlideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
