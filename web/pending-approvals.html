<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pending Approvals - Job Order Management</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/dashboard.html" class="sidebar-logo">
                    <div class="sidebar-logo-icon">JO</div>
                    <div>
                        <div class="sidebar-logo-text">Job Orders</div>
                        <div class="sidebar-logo-subtitle">Management System</div>
                    </div>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main Menu</div>
                    <a href="/dashboard.html" class="nav-item">
                        Dashboard
                    </a>
                    <a href="/" class="nav-item" id="newJobOrderNav">
                        New Job Order
                    </a>
                    <a href="/reports.html" class="nav-item" id="reportsNav">
                        Reports
                    </a>
                    <a href="/pending-approvals.html" class="nav-item active">
                        <span id="navApprovalLabel">Pending Approvals</span>
                        <span class="nav-item-badge" id="pendingCountBadge" style="display: none;">0</span>
                    </a>
                </div>

                <div class="nav-section" id="adminSection" style="display: none;">
                    <div class="nav-section-title">Administration</div>
                    <a href="/admin.html" class="nav-item">
                        Signatures
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="sidebar-user" id="sidebarUser">
                    <div class="sidebar-user-avatar" id="sidebarAvatar">U</div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name" id="sidebarUserName">User</div>
                        <div class="sidebar-user-role" id="sidebarUserRole">Staff</div>
                    </div>
                </div>
                <button class="btn btn-ghost btn-full mt-2" id="settingsBtn" style="justify-content: flex-start; gap: 12px;">
                    Settings
                </button>
                <button class="btn btn-ghost btn-full mt-2" id="logoutBtn" style="justify-content: flex-start; gap: 12px;">
                    Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="icon-btn mobile-menu-toggle" id="menuToggle" style="display: none;">Menu</button>
                    <div>
                        <h1 class="page-title">Pending Approvals</h1>
                        <div class="breadcrumb">
                            <span>Home</span>
                            <span class="breadcrumb-separator">/</span>
                            <span>Pending Approvals</span>
                        </div>
                    </div>
                </div>
                <div class="top-bar-right">
                    <button class="btn btn-secondary btn-sm" onclick="loadApprovals()">
                        Refresh
                    </button>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                <div class="alert alert-info mb-4" id="staffApprovalNotice" style="display: none;">
                    <div class="alert-icon"></div>
                    <div class="alert-content">
                        <div class="alert-title">Your Signature Requests</div>
                        <div class="alert-message">
                            Review the requests below and use Approve or Reject. Once you approve, the leader can generate the report.
                        </div>
                    </div>
                </div>
                <!-- Stats Grid -->
                <div class="stats-grid mb-6" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card" style="--stat-color: var(--warning);">
                        <div class="stat-card-icon warning"></div>
                        <div class="stat-card-content">
                            <div class="stat-card-title">Awaiting Response</div>
                            <div class="stat-card-value" id="statPending">0</div>
                        </div>
                    </div>
                    <div class="stat-card" style="--stat-color: var(--success);">
                        <div class="stat-card-icon success"></div>
                        <div class="stat-card-content">
                            <div class="stat-card-title">Approved</div>
                            <div class="stat-card-value" id="statApproved">0</div>
                        </div>
                    </div>
                    <div class="stat-card" style="--stat-color: var(--error);">
                        <div class="stat-card-icon error"></div>
                        <div class="stat-card-content">
                            <div class="stat-card-title">Rejected</div>
                            <div class="stat-card-value" id="statRejected">0</div>
                        </div>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div class="card">
                    <div class="tabs" style="padding: 0 24px; margin-bottom: 0; border-bottom: 2px solid var(--border-light);">
                        <button class="tab active" data-filter="all">
                            All Requests
                        </button>
                        <button class="tab" data-filter="pending">
                            Pending
                        </button>
                        <button class="tab" data-filter="approved">
                            Approved
                        </button>
                        <button class="tab" data-filter="rejected">
                            Rejected
                        </button>
                    </div>

                    <div class="card-body">
                        <div id="approvalsList">
                            <div class="empty-state" style="padding: 60px;">
                                <div class="spinner"></div>
                                <p class="loading-text mt-4">Loading approval requests...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Settings</h3>
                <button class="modal-close" id="closeSettingsModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="settingsForm">
                    <div class="form-group">
                        <label class="form-label">Save Reports To</label>
                        <div class="flex gap-2">
                            <input type="text" class="form-input" id="savePathInput" placeholder="e.g., \\\\server\\share\\Reports or C:\\Reports">
                            <button type="button" class="btn btn-secondary" id="browseSavePathBtn">Browse</button>
                        </div>
                        <input type="file" id="savePathPicker" webkitdirectory directory style="display: none;">
                        <small class="text-secondary" style="display: block; margin-top: 8px;">
                            Enter a network path or local folder where generated reports will be saved.
                            Leave empty to use the default server location.
                        </small>
                    </div>
                    <div class="flex gap-4 mt-4">
                        <button type="button" class="btn btn-secondary btn-full" id="cancelSettingsBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary btn-full">Save Settings</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // =============================================================================
        // STATE
        // =============================================================================
        let currentUser = null;
        let allApprovals = [];
        let currentFilter = 'all';

        const settingsModal = document.getElementById('settingsModal');
        const settingsForm = document.getElementById('settingsForm');
        const settingsBtn = document.getElementById('settingsBtn');

        // =============================================================================
        // INITIALIZATION
        // =============================================================================
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            initTabs();
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            if (settingsBtn) {
                settingsBtn.addEventListener('click', openSettingsModal);
            }
            const closeSettingsModal = document.getElementById('closeSettingsModal');
            const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');
            if (closeSettingsModal) {
                closeSettingsModal.addEventListener('click', () => settingsModal.classList.remove('active'));
            }
            if (cancelSettingsBtn) {
                cancelSettingsBtn.addEventListener('click', () => settingsModal.classList.remove('active'));
            }
            if (settingsForm) {
                settingsForm.addEventListener('submit', handleSaveSettings);
            }
            setupSavePathPicker();
        });

        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentFilter = tab.dataset.filter;
                    renderApprovals();
                });
            });
        }

        // =============================================================================
        // AUTH
        // =============================================================================
        async function checkAuth() {
            try {
                const res = await fetch('/auth/me', { credentials: 'include' });
                if (!res.ok) {
                    window.location.href = '/';
                    return;
                }

                const data = await res.json();
                if (!data.user) {
                    window.location.href = '/';
                    return;
                }

                currentUser = data.user;
                updateUserUI();
                loadApprovals();
            } catch (err) {
                window.location.href = '/';
            }
        }

        async function handleLogout() {
            try {
                await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
            } catch (error) {
                console.error('Logout error:', error);
            }
            window.location.href = '/';
        }

        function updateUserUI() {
            document.getElementById('sidebarAvatar').textContent = (currentUser.name || currentUser.username || 'U').charAt(0).toUpperCase();
            document.getElementById('sidebarUserName').textContent = currentUser.name || currentUser.username || 'User';

            // Show role based on user type
            const roleLabel = currentUser.isAdmin ? 'Administrator' : currentUser.isLeader ? 'Leader' : 'Staff';
            document.getElementById('sidebarUserRole').textContent = roleLabel;

            if (currentUser.isAdmin) {
                document.getElementById('adminSection').style.display = 'block';
            }

            const isStaffOnly = !currentUser.isAdmin && !currentUser.isLeader;
            const newJobNav = document.getElementById('newJobOrderNav');
            if (newJobNav && isStaffOnly) {
                newJobNav.style.display = 'none';
            }

            const reportsNav = document.getElementById('reportsNav');
            if (reportsNav && isStaffOnly) {
                reportsNav.style.display = 'none';
            }

            const navLabel = document.getElementById('navApprovalLabel');
            if (navLabel && isStaffOnly) {
                navLabel.textContent = 'My Signature Requests';
            }

            const staffNotice = document.getElementById('staffApprovalNotice');
            if (staffNotice) {
                staffNotice.style.display = isStaffOnly ? 'flex' : 'none';
            }

            if (isStaffOnly) {
                document.querySelector('.page-title').textContent = 'My Signature Requests';
                document.querySelector('.breadcrumb').innerHTML = '<span>Home</span><span class="breadcrumb-separator">/</span><span>My Signature Requests</span>';
            }
        }

        // =============================================================================
        // USER SETTINGS
        // =============================================================================
        async function openSettingsModal() {
            if (!settingsModal) return;

            try {
                const response = await fetch('/api/user/settings', { credentials: 'include' });
                const data = await response.json();

                if (data.success) {
                    const savePathInput = document.getElementById('savePathInput');
                    if (savePathInput) {
                        savePathInput.value = data.settings.savePath || '';
                    }
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }

            settingsModal.classList.add('active');
        }

        async function handleSaveSettings(e) {
            e.preventDefault();

            const savePathInput = document.getElementById('savePathInput');
            const savePath = savePathInput ? savePathInput.value.trim() : '';

            try {
                const response = await fetch('/api/user/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ savePath })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Settings saved successfully!', 'success');
                    settingsModal.classList.remove('active');
                } else {
                    showToast(data.error || 'Failed to save settings', 'error');
                }
            } catch (error) {
                console.error('Failed to save settings:', error);
                showToast('Failed to save settings', 'error');
            }
        }

        function setupSavePathPicker() {
            const browseBtn = document.getElementById('browseSavePathBtn');
            const savePathInput = document.getElementById('savePathInput');
            const savePathPicker = document.getElementById('savePathPicker');

            if (!browseBtn || !savePathInput) return;

            browseBtn.addEventListener('click', async () => {
                if (window.showDirectoryPicker) {
                    try {
                        const handle = await window.showDirectoryPicker();
                        if (handle?.name) {
                            savePathInput.value = handle.name;
                        }
                        return;
                    } catch (error) {
                        if (error?.name !== 'AbortError') {
                            console.error('Failed to open directory picker:', error);
                        }
                    }
                }

                if (savePathPicker) {
                    savePathPicker.click();
                }
            });

            if (savePathPicker) {
                savePathPicker.addEventListener('change', () => {
                    const file = savePathPicker.files?.[0];
                    if (!file) return;
                    const path = getSelectedDirectoryPath(file);
                    if (path) {
                        savePathInput.value = path;
                    }
                    savePathPicker.value = '';
                });
            }
        }

        function getSelectedDirectoryPath(file) {
            if (file.path) {
                const lastSeparator = Math.max(file.path.lastIndexOf('/'), file.path.lastIndexOf('\\'));
                return lastSeparator >= 0 ? file.path.slice(0, lastSeparator) : file.path;
            }
            if (file.webkitRelativePath) {
                return file.webkitRelativePath.split('/')[0];
            }
            return '';
        }

        // =============================================================================
        // APPROVALS
        // =============================================================================
        async function loadApprovals() {
            const listDiv = document.getElementById('approvalsList');
            listDiv.innerHTML = `
                <div class="empty-state" style="padding: 60px;">
                    <div class="spinner"></div>
                    <p class="loading-text mt-4">Loading approval requests...</p>
                </div>
            `;

            try {
                const res = await fetch('/api/approvals/pending', { credentials: 'include' });
                if (!res.ok) throw new Error('Failed to load');

                const data = await res.json();
                allApprovals = data.approvals || [];

                updateStats();
                renderApprovals();
            } catch (err) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-title">Failed to Load</div>
                        <div class="empty-state-description">Unable to load approval requests. Please try again.</div>
                    </div>
                `;
            }
        }

        function updateStats() {
            const pending = allApprovals.filter(a => a.status === 'pending').length;
            const approved = allApprovals.filter(a => a.status === 'approved').length;
            const rejected = allApprovals.filter(a => a.status === 'rejected').length;

            document.getElementById('statPending').textContent = pending;
            document.getElementById('statApproved').textContent = approved;
            document.getElementById('statRejected').textContent = rejected;

            const badge = document.getElementById('pendingCountBadge');
            if (pending > 0) {
                badge.textContent = pending;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }

        function renderApprovals() {
            const listDiv = document.getElementById('approvalsList');
            let filtered = allApprovals;

            if (currentFilter !== 'all') {
                filtered = allApprovals.filter(a => a.status === currentFilter);
            }

            if (filtered.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-title">No Approval Requests</div>
                        <div class="empty-state-description">
                            ${currentFilter === 'all'
                                ? 'There are no signature approval requests yet.'
                                : `No ${currentFilter} requests found.`}
                        </div>
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = `
                <div class="approval-list">
                    ${filtered.map(approval => renderApprovalCard(approval)).join('')}
                </div>
            `;
        }

        function renderApprovalCard(approval) {
            const statusBadge = {
                pending: '<span class="badge badge-warning">Pending</span>',
                approved: '<span class="badge badge-success">Approved</span>',
                rejected: '<span class="badge badge-error">Rejected</span>'
            }[approval.status];

            const createdDate = new Date(approval.createdAt).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const reportData = approval.reportData || {};
            const isCreator = approval.createdBy?.toLowerCase() === currentUser?.email?.toLowerCase();
            const isStaffApprover = approval.staffEmail?.toLowerCase() === currentUser?.email?.toLowerCase();
            const canRespond = approval.status === 'pending' && isStaffApprover;
            const canReview = isStaffApprover;
            const canGenerate = approval.status === 'approved' && (currentUser?.isAdmin || currentUser?.isLeader || isCreator);
            const canDelete = currentUser?.isAdmin || isCreator;

            return `
                <div class="card mb-4" id="approval-${approval.token}">
                    <div class="card-body">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <div class="avatar avatar-lg" style="background: var(--primary-100); color: var(--primary);">
                                    ${(approval.staffName || 'S').charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h4 class="font-semibold mb-1">${approval.staffName || 'Staff Member'}</h4>
                                    <p class="text-secondary text-sm">${approval.staffEmail || ''}</p>
                                </div>
                            </div>
                            ${statusBadge}
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4" style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                            <div>
                                <p class="text-secondary text-xs mb-1">Requested By</p>
                                <p class="font-medium text-sm">${approval.createdByName || 'Unknown'}</p>
                            </div>
                            <div>
                                <p class="text-secondary text-xs mb-1">Date Requested</p>
                                <p class="font-medium text-sm">${createdDate}</p>
                            </div>
                            ${reportData.engineer ? `
                            <div>
                                <p class="text-secondary text-xs mb-1">Engineer</p>
                                <p class="font-medium text-sm">${reportData.engineer}</p>
                            </div>
                            ` : ''}
                            ${reportData.description ? `
                            <div>
                                <p class="text-secondary text-xs mb-1">Description</p>
                                <p class="font-medium text-sm" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${reportData.description}</p>
                            </div>
                            ` : ''}
                        </div>

                        <div class="flex gap-2 justify-end">
                            ${canReview ? `
                                <a class="btn btn-secondary" href="/approval-review.html?token=${approval.token}">
                                    Review Request
                                </a>
                            ` : ''}
                            ${canRespond ? `
                                <button class="btn btn-success" onclick="respondToApproval('${approval.token}', 'approve')">
                                    Approve
                                </button>
                                <button class="btn btn-error" onclick="respondToApproval('${approval.token}', 'reject')">
                                    Reject
                                </button>
                            ` : ''}
                            ${canGenerate ? `
                                <button class="btn btn-success" onclick="generateFromApproval('${approval.token}')">
                                    Generate Report
                                </button>
                            ` : ''}
                            ${canDelete ? `
                                <button class="btn btn-ghost" onclick="deleteApproval('${approval.token}')">
                                    Delete
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        async function generateFromApproval(token) {
            const approval = allApprovals.find(a => a.token === token);
            if (!approval || approval.status !== 'approved') {
                showToast('This request has not been approved yet', 'error');
                return;
            }

            try {
                const res = await fetch(`/api/approvals/${token}/generate`, {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Report generation failed');
                }

                const savedPath = data.savedPath || data.folder;
                showToast(`Job order ${data.job_no} generated successfully! Saved to: ${savedPath}`, 'success');

                // Refresh the page to update the list
                setTimeout(() => loadApprovals(), 1500);
            } catch (err) {
                showToast(err.message || 'Failed to generate report', 'error');
            }
        }

        async function respondToApproval(token, action) {
            const actionLabel = action === 'approve' ? 'approve' : 'reject';
            if (!confirm(`Are you sure you want to ${actionLabel} this signature request?`)) return;

            try {
                const res = await fetch(`/api/approvals/respond/${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ action })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Response failed');
                }

                const approval = allApprovals.find(a => a.token === token);
                if (approval) {
                    approval.status = data.status;
                    approval.respondedAt = new Date().toISOString();
                }

                updateStats();
                renderApprovals();
                showToast(data.message || 'Response recorded', 'success');
            } catch (error) {
                showToast(error.message || 'Failed to respond', 'error');
            }
        }

        async function deleteApproval(token) {
            if (!confirm('Are you sure you want to delete this approval request?')) return;

            try {
                const res = await fetch(`/api/approvals/${token}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Delete failed');
                }

                document.getElementById(`approval-${token}`).remove();
                allApprovals = allApprovals.filter(a => a.token !== token);
                updateStats();

                if (allApprovals.filter(a => currentFilter === 'all' || a.status === currentFilter).length === 0) {
                    renderApprovals();
                }

                showToast('Approval request deleted', 'success');
            } catch (err) {
                showToast(err.message || 'Failed to delete', 'error');
            }
        }

        // =============================================================================
        // TOAST
        // =============================================================================
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '' : type === 'error' ? '' : ''}</span>
                <span>${message}</span>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'toastSlideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>

    <style>
        .approval-list {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .approval-list .card {
            border-radius: 0;
            border-bottom: 1px solid var(--border-light);
            box-shadow: none;
        }

        .approval-list .card:first-child {
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .approval-list .card:last-child {
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            border-bottom: none;
        }

        .approval-list .card:only-child {
            border-radius: var(--radius-lg);
        }
    </style>
</body>
</html>
